name: Build Base Images

on:
  workflow_dispatch:

jobs:
  dispatch_and_poll:
    runs-on: [self-hosted]
    steps:
      - uses: actions/checkout@v3

      - name: Generate Trigger Id
        id: gen
        run: |
          #!/bin/sh
          TRIGGER_ID=$(date +%s)
          echo $TRIGGER_ID
          echo "trigger_id=$TRIGGER_ID" >> $GITHUB_OUTPUT

      - name: Dispatch Public Workflow  
        run : |
          response=$(curl -s -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GIT_TOKEN }}" \
            --insecure \
            https://api.github.com/repos/prasathmahendraraja/sre-base-image-builder/actions/workflows/build-and-push-base-images.yml/dispatches \
            -d '{"ref": "main", "inputs": {"trigger_id": "${{ steps.gen.outputs.trigger_id }}"}}')          
          
          echo "Response From Dispatch: $response"

      - name: Wait a few seconds to let the child start
        run: sleep 10

      - name: Get public workflow run ID
        id: get_run
        run: |
          RUN_ID=""
          for i in {1..10}; do
            echo "Attempt $i: Checking for child workflow run..."
            RUN_ID=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GIT_TOKEN }}" \
              "https://api.github.com/repos/prasathmahendraraja/sre-base-image-builder/actions/workflows/build-and-push-base-images.yml/runs?branch=main&event=workflow_dispatch" \
              | jq -r  '.workflow_runs[] | select(.head_branch=="main") | .id' | head -n 1)

            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              echo "Found run ID: $RUN_ID"
              echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
              break
            fi
            sleep 5
          done

      - name: Wait for dispatched workflow to finish
        if: steps.get_run.outputs.run_id != ''
        run: |
          while true; do
            STATUS=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GIT_TOKEN }}" \
              "https://api.github.com/repos/prasathmahendraraja/sre-base-image-builder/actions/runs/${{ steps.get_run.outputs.run_id }}" \
              | jq -r '.status')
            CONCLUSION=$(curl -s \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GIT_TOKEN }}" \
              "https://api.github.com/repos/prasathmahendraraja/sre-base-image-builder/actions/runs/${{ steps.get_run.outputs.run_id }}" \
              | jq -r '.conclusion')
            echo "Status: $STATUS | Conclusion: $CONCLUSION"
            if [ "$STATUS" = "completed" ]; then
              if [ "$CONCLUSION" = "success" ]; then
                echo "✅ Dispatched workflow completed successfully!"
                exit 0
              else
                echo "❌ Dispatched workflow failed!"
                exit 1
              fi
            fi
            sleep 15
          done